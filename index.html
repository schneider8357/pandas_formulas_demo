<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Spreadsheet UI (minimal)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --colw: 120px; }
    body { font-family: system-ui, sans-serif; margin: 20px; }
    h1 { font-size: 18px; margin: 0 0 12px; }
    .controls { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; align-items: center; }
    .controls input { padding: 6px 8px; }
    .controls button { padding: 6px 10px; cursor: pointer; }
    .muted { color: #666; }

    /* Scrollable grid container */
    .sheet-wrap {
      border: 1px solid #e5e7eb;
      height: 70vh;            /* vertical space for scrolling */
      max-width: 100%;
      overflow: auto;          /* both horizontal and vertical scrolls */
      background: #fff;
    }

    table {
      border-collapse: collapse;
      table-layout: fixed;     /* respect fixed cell widths */
      width: auto;             /* expand as needed; wrapper will scroll */
    }

    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;

      /* fixed column width */
      width: var(--colw);
      min-width: var(--colw);
      max-width: var(--colw);
    }

    th {
      background: #f5f5f5;
      position: sticky;
      top: 0;                  /* sticky header on vertical scroll */
      z-index: 1;
    }

    td:hover { background: #fff9db; cursor: pointer; }

    /* Row-number column (not part of data columns) */
    .rownum {
      width: 60px !important;
      min-width: 60px !important;
      max-width: 60px !important;
      text-align: right;
      color: #666;
      background: #fafafa;
    }

    #status { margin-top: 10px; min-height: 18px; }
  </style>
</head>
<body>
  <h1>Spreadsheet (API client)</h1>

  <div class="help">
    <h2>How it works (super short):</h2>
    <ul>
      <li><b>View spreadsheet:</b> Loads automatically. Click <code>Refresh</code> anytime.</li>
      <li><b>Edit a cell:</b> Click a cell → enter a <i>value</i> (e.g. <code>123</code>) or a <i>formula</i> starting with <code>=</code>.</li>
      <li><b>See formulas:</b> Clicking a formula cell shows the <code>=formula</code> in the editor instead of the computed value.</li>
      <li><b>Add row / column:</b> Use <code>Add Row</code> or <code>Add Column</code>; the sheet auto-expands like Excel.</li>
      <li><b>Auto-recalc:</b> Changing a referenced cell recomputes all dependent formulas.</li>
    </ul>

    <h2>Formulas you can use:</h2>
    <ul>
      <li><b>Operators:</b> <code>+</code> <code>-</code> <code>*</code> <code>/</code> <code>^</code> (power), parentheses <code>( )</code></li>
      <li><b>Common functions:</b> <code>SUM</code>, <code>AVERAGE</code>, <code>MIN</code>, <code>MAX</code>, <code>COUNT</code></li>
      <li><b>Logic:</b> <code>IF</code>, <code>AND</code>, <code>OR</code>, <code>NOT</code>, comparisons <code>&gt;</code> <code>&gt;=</code> <code>&lt;</code> <code>&lt;=</code> <code>=</code> <code>&lt;&gt;</code></li>
      <li><b>Conditional aggregations:</b> <code>SUMIF</code>, <code>COUNTIF</code>, <code>AVERAGEIF</code> (and their <code>*IFS</code> variants may work depending on expression)</li>
    </ul>

    <h2>Ranges & examples:</h2>
    <ul>
      <li><b>Single cell:</b> <code>A1</code></li>
      <li><b>Row/column block:</b> <code>A1:A10</code>, <code>A1:B3</code></li>
      <li><b>Mixed args:</b> you can combine ranges and cells in one function</li>
    </ul>
    <ul>
      <li><code>=A1+B1</code></li>
      <li><code>=SUM(A1:A5)</code></li>
      <li><code>=AVERAGE(B2:B10)</code></li>
      <li><code>=IF(C2&gt;100,"OK","NO")</code></li>
      <li><code>=SUMIF(A1:A10,"&gt;10",B1:B10)</code></li>
      <li><code>=SUM(A1:A3, C1, D2:D3)</code></li>
    </ul>
    <div class="muted">Tip: values that look numeric are sent as numbers; empty input clears to <code>null</code>.</div>
  </div>

  <div class="controls">
    <label>Cell <input id="cell" placeholder="e.g. B3" /></label>
    <label>Value/Formula <input id="val" placeholder='123 or =SUM(A1:A3)' size="28" /></label>
    <button id="apply">Apply</button>
    <button id="addRow">Add Row</button>
    <button id="addCol">Add Column</button>
    <button id="refresh">Refresh</button>
    <span class="muted">Click a cell to edit (shows formula if present).</span>
  </div>

  <div class="sheet-wrap">
    <table id="sheet"></table>
  </div>

  <div id="status" class="muted"></div>

  <script>
    const BASE = ''; // same-origin with FastAPI

    function showStatus(msg, isError=false) {
      const el = document.getElementById('status');
      el.textContent = msg || '';
      el.style.color = isError ? '#b00020' : '#666';
    }

    function idxToCol(idx) {
      let s = ''; idx = idx + 1;
      while (idx > 0) { const r = (idx - 1) % 26; s = String.fromCharCode(65 + r) + s; idx = Math.floor((idx - 1) / 26); }
      return s;
    }

    async function apiGet(path) {
      const r = await fetch(BASE + path);
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }
    async function apiPost(path, body) {
      const r = await fetch(BASE + path, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }

    async function getFormula(cell) {
      const res = await apiGet(`/formula/${cell}`);
      return res.formula ?? null;
    }

    async function setCell(cell, valueOrFormula) {
      const s = String(valueOrFormula ?? '').trim();
      if (s.startsWith('=')) {
        return apiPost('/formula', { cell, formula: s });
      }
      let v = valueOrFormula;
      if (s === '') v = null;
      else if (!isNaN(s)) v = Number(s);
      return apiPost('/value', { cell, value: v });
    }

    function renderSheet(payload) {
      const { columns, data } = payload;
      const tbl = document.getElementById('sheet');
      tbl.innerHTML = '';

      // header
      const thead = document.createElement('thead');
      const hr = document.createElement('tr');
      const rowHdr = document.createElement('th');
      rowHdr.className = 'rownum';
      rowHdr.textContent = '#';
      hr.appendChild(rowHdr);
      for (const col of columns) {
        const th = document.createElement('th');
        th.textContent = col;
        hr.appendChild(th);
      }
      thead.appendChild(hr);
      tbl.appendChild(thead);

      // body
      const tbody = document.createElement('tbody');
      for (let r = 0; r < data.length; r++) {
        const tr = document.createElement('tr');
        const rn = document.createElement('td');
        rn.className = 'rownum';
        rn.textContent = (r + 1).toString();
        tr.appendChild(rn);

        for (let c = 0; c < columns.length; c++) {
          const td = document.createElement('td');
          const a1 = `${columns[c]}${r + 1}`;
          const v = data[r][c];
          td.dataset.cell = a1;
          td.title = a1;
          td.textContent = (v === null || v === undefined) ? '' : v;

          td.addEventListener('click', async () => {
            const f = await getFormula(a1).catch(() => null);
            const initial = f || td.textContent || '';
            const input = prompt(`Edit ${a1}\nEnter value or a formula starting with "="`, initial);
            if (input === null) return;
            try {
              await setCell(a1, input);
              await loadAndRender();
              showStatus(`Updated ${a1}`);
            } catch (e) {
              console.error(e);
              showStatus(`Error updating ${a1}: ${e.message}`, true);
            }
          });

          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
      tbl.appendChild(tbody);
    }

    async function loadAndRender() {
      showStatus('Loading...');
      try {
        const sheet = await apiGet('/sheet');
        renderSheet(sheet);
        showStatus(`Loaded ${sheet.n_rows} rows × ${sheet.n_cols} cols`);
        return sheet;
      } catch (e) {
        console.error(e);
        showStatus('Failed to load: ' + e.message, true);
      }
    }

    document.getElementById('apply').addEventListener('click', async () => {
      const cell = document.getElementById('cell').value.trim();
      const val = document.getElementById('val').value;
      if (!cell) return showStatus('Enter a cell like B3', true);
      try {
        await setCell(cell, val);
        await loadAndRender();
        showStatus(`Applied to ${cell}`);
      } catch (e) {
        console.error(e);
        showStatus('Error: ' + e.message, true);
      }
    });

    document.getElementById('addRow').addEventListener('click', async () => {
      try {
        const sheet = await apiGet('/sheet');
        const newRow1 = sheet.n_rows + 1;
        await apiPost('/value', { cell: `A${newRow1}`, value: null }); // auto-expand
        await loadAndRender();
        showStatus(`Added row ${newRow1}`);
      } catch (e) {
        console.error(e);
        showStatus('Error adding row: ' + e.message, true);
      }
    });

    document.getElementById('addCol').addEventListener('click', async () => {
      try {
        const sheet = await apiGet('/sheet');
        const newColLetter = idxToCol(sheet.n_cols);
        await apiPost('/value', { cell: `${newColLetter}1`, value: null }); // auto-expand
        await loadAndRender();
        showStatus(`Added column ${newColLetter}`);
      } catch (e) {
        console.error(e);
        showStatus('Error adding column: ' + e.message, true);
      }
    });

    document.getElementById('refresh').addEventListener('click', loadAndRender);

    loadAndRender();
  </script>
</body>
</html>
